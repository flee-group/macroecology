---
title: "Boidiversity Modelling"
author: "Matthew Talluto"
date: "27.04.2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message = FALSE}
library(sf)
library(fasterize)
library(raster)
library(ggplot2)
library(rnaturalearth)
library(scico)
library(gridExtra)

```

Today we will be exploring biodiversity using the IUCN rangemaps that we briefly explored in the first exercise. Note that this dataset includes all species for which the IUCN performs an assessment, and that, being expert-derived rangemaps, the resolution is rather coarse. Thus, our interpretations must be made with care, as they will necessarily represent approximate or potential diversity, rather than diversity as measured during (e.g.) a biodiversity inventory.

First let's load and visualise the response variable. The mammal range maps, cropped to the same extent we have had before, are in the `mammal_ranges.rds` file. We can use the `fasterize` function to convert these individual range polygons into a map of species richness (by counting the number of polygons overlapping each grid cell). We use the climate data as the template for our raster.

```{r fasterize}
mamm = readRDS("../data/biodiv/mammal_ranges.rds")
clim_pres = stack("../data/bioclim_pres.grd")
mamm_r = fasterize(mamm, clim_pres[[1]], fun = "sum", background = NA)
suppressMessages(countries <- st_crop(ne_countries(scale="medium", returnclass = "sf"), mamm_r))

mamm_pl = as.data.frame(rasterToPoints(mamm_r))
c_map = ggplot(countries) + geom_sf(colour='black', fill='white') + xlab("") + ylab("")
c_map + geom_tile(data = mamm_pl, aes(x=x, y=y, fill=layer), alpha = 0.8) + 
	scale_fill_scico(palette="davos") + labs(fill="Mammal Species Richness")

```

Some patterns in species richness should be immediately apparent, especially the gradient from lowlands to mountains.

## 1. Concept

Here I will propose a few modelling questions that we can pursue given the data we have with us for this exercise. However, other models are also possible; consider other hypotheses and pursue them following your own interests.

Some starter questions:

  1. What is the shape of the relationship between diversity and elevation?
  2. Are any climatic patterns evident after controlling for elevation?
  3. How does human influence affect diversity?
  4. Are there any notable spatial (e.g., latitudinal) gradients in richness after accounting for other factors?
  5. Do any of the above patterns change if we consider only species that are listed as threatened or endangered?
  
We have several distributions we could try for modelling species richness. Two that are commonly used are the Poisson and the lognormal.

Poisson models are useful for count data, especially with small counts (lower than 50). About 50% of our raster cells have fewer than 50 species, so this model is sensible. However, it comes with some assumptions. In particular, we must assume that species richness is conditionally Poisson distributed; this means that, if we hold all of the predictors in our model constant, we get Poisson distributed species richness (meaning that the variance in species richness is equal to the mean). We can check the marginal distribution to start:

```{r poisson}
sr = mamm_pl[,3]
xx = 0:max(sr)
yy = dpois(xx, mean(sr))
hist(sr, main = "", xlab = "Species Richness", freq=FALSE, ylim=c(0, max(yy)))
lines(density(sr, bw=5), lwd=2, col='red')
lines(xx, yy, lwd=2, col='blue')
legend("topleft", legend=c("empirical", "theoretical", 
						   paste("mean =", round(mean(sr), 2)), paste("var =", round(var(sr), 2))),
	   lwd=c(2,2,0,0), col=c('red', 'blue', 'white', 'white'))

```

So marginal species richness is not poisson distributed; the variance is too high and there are too many low-richness sites. Perhaps this will get better with other predictors, but we can at least check the lognormal as well to see if it fits best before adding predictors.

```{r lognormal}
yy = dlnorm(xx, mean(log(sr)), sd(log(sr)))
hist(sr, main = "", xlab = "Species Richness", freq=FALSE)
lines(density(sr, bw=5), lwd=2, col='red')
lines(xx, yy, lwd=2, col='blue')
legend("topleft", legend=c("empirical", "theoretical", 
						   paste("mean =", round(mean(sr), 2)), paste("var =", round(var(sr), 2))),
	   lwd=c(2,2,0,0), col=c('red', 'blue', 'white', 'white'))

```

The lognormal appears to be an even worse fit, with too few high-diversity areas and too many low-diversity sites. So we will stick with the Poisson, keeping in mind we should be on the lookout for *overdispersion* (excess variance in the residuals), indicating that our model assumptions might not be met.


## 2. Data preparation

Our main task here is to load in all of the data sources we would like to use, get them into a unified format (same projection, extent and resolution), and then transform them into a data.frame for further analysis. In addition to the mammal range maps and the climate data from previous exercises, we now have a digital elevation model from the [Copernicus land monitoring service](https://www.eea.europa.eu/data-and-maps/data/copernicus-land-monitoring-service-eu-dem), the [human influence index](https://sedac.ciesin.columbia.edu/data/set/wildareas-v2-human-influence-index-geographic), and the [Corine Land Cover dataset](https://land.copernicus.eu/pan-european/corine-land-cover/clc2018?tab=download). Note that the Corine data is quite large (100-m resolution for all Europe), thus I have already cropped and downscaled the data for this exercise. Here we load and visualise these datasets.

```{r read_data, figure.width = 12}
elev = raster("../data/biodiv/elevation.grd")
hii = raster("../data/biodiv/hii.grd")

p1 = c_map + geom_tile(data = as.data.frame(rasterToPoints(elev)), aes(x=x, y=y, fill=dem_global_30sec)) + scale_fill_scico(palette = "grayC") +
	labs(fill = "Elevation (m)")
p2 = c_map + geom_tile(data = as.data.frame(rasterToPoints(hii)), aes(x=x, y=y, fill=hii_v2geo)) + scale_fill_scico(palette = "bamako") + 
	labs(fill="Human Influence Index")
grid.arrange(p1, p2, nrow=1)
```

A new problem is the map projection used. Previously, we have been ok to use latitude and longitude coordinates. However, our analysis now is accumulating species within grid cells; this analysis will be biased because the grid cells vary in area based on latitude (and the species area relationship tells us that larger areas have more species). Thus, we must reproject our species ranges into an *equal area projection*, recompute the species richness, and then reproject our predictor variables as well.

We will use the [European Lambert equal area conic projection](https://epsg.io/3035); this projection is recommended by the [European Research Council](https://www.eea.europa.eu/data-and-maps/data/eea-reference-grids-2) as an appropriate tool for map-based statistical analysis. We use the `projectRaster` function, which can either operate using the spatial reference directly, or which can be given a template raster. In the case of a template raster, the output will be reprojected AND resampled so that the origin, extent, and resolution match the template.

```{r reproject}

```


## Outline

## Data prep and visualisation
-- human influence index ()
-- elevation ()
-- temperature & precip (already used)

### get all raster layers into the same (3035) projection and extent


## Joining data
They are already joined, because they are raster format
note that it is problematic to do analyses on this, because geographic effects are confounded
we have a few possibilities; we could subsample (but not super nice)
we can use space in the model somehow (try with GAM)
we can treat our model as exploratory and not try to over interpret

## extract data as points

## fit a Poisson GLM
## try with a GAM as well
	can use s(x,y) to get a 2-d smoothed surface
	
a bit about GAM
subsampling if needed

## Visualising and interpreting



<br/><br/><br/>
<p style="font-size:small">
[CC-BY 4.0](http://creativecommons.org/licenses/by/4.0/)</p>
